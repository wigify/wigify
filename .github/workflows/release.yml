name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Bump version
        run: |
          npm version ${{ github.event.inputs.version }} --no-git-tag-version

      - name: Typecheck
        run: bun run typecheck

      - name: Lint
        run: bun lint

      - name: Test
        run: bun run test

      - name: Setup macOS certificates
        env:
          MACOS_CERTIFICATE: ${{ secrets.MAC_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PWD: ${{ secrets.MAC_KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$MACOS_KEYCHAIN_PWD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MACOS_KEYCHAIN_PWD" build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_KEYCHAIN_PWD" build.keychain
          rm certificate.p12

      - name: Build and publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: bun run release-mac

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}"
          git tag "v${{ github.event.inputs.version }}"
          git push origin HEAD --tags

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ZIP_FILE="release/${VERSION}/Wigify-Mac-${VERSION}-arm64.zip"
          SHA256=$(shasum -a 256 "$ZIP_FILE" | awk '{print $1}')

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/wigify/homebrew-tap.git
          cd homebrew-tap

          cat > Casks/wigify.rb << EOF
          cask "wigify" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/wigify/wigify/releases/download/v#{version}/Wigify-Mac-#{version}-arm64.zip"
            name "Wigify"
            desc "Create and display custom HTML/CSS/JS widgets on your desktop"
            homepage "https://github.com/wigify/wigify"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Wigify.app"

            zap trash: [
              "~/Library/Application Support/wigify",
              "~/Library/Preferences/com.wigify.app.plist",
              "~/Library/Saved Application State/com.wigify.app.savedState",
            ]
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/wigify.rb
          git commit -m "Update wigify to $VERSION"
          git push
